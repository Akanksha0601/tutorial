{
  "_id": "global-customer",
  "type": "pipe",
  "source": {
    "type": "merge",
    "datasets": ["crm-customer crm", "erp-customer erp", "csv-import-person cip"],
    "equality": [
      ["eq", "erp.company_id", "crm.company_id"],
      ["eq", "crm.birthday", "cip.Birthday"]
    ],
    "identity": "first",
    "strategy": "compact",
    "version": 2
  },
  "transform": [{
    "type": "dtl",
    "rules": {
      "default": [
        ["copy", "*"],
        ["add", "type", "customer"],
        ["merge-union",
          ["apply-hops", "orders", {
            "datasets": ["global-order gor"],
            "where": [
              ["eq", "_S.$ids", "gor.customer_id"]
            ]
          }]
        ],
        ["add", "order_count",
          ["sum", "_T.items.quantity"]
        ],
        ["add", "name",
          ["concat",
            ["list", "_S.GivenName", " ", "_S.MiddleInitial", ".", " ", "_S.Surname"]
          ]
        ],
        ["add", "vipcustomer",
          ["gt", "_T.order_count", 2]
        ],
        ["add", "isOver21",
          ["gt", "_S.age", 21]
        ],
        ["if",
          ["eq", "_T.isOver21", true],
          ["add", "type", "mayBuyAlcohol"],
          ["add", "type", "cannotBuyAlcohol"]
        ],
        ["add", "isGoldCustomer",
          ["gt", "_T.order_count", 0]
        ]
      ],
      "orders": [
        ["copy", "*"]
      ]
    }
  }],
  "namespaced_identifiers": true
}
